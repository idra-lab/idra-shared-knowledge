<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><link rel="prev" title="Github Actions for CI/CD" href="../03_github_actions/00_index.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2023.09.10 -->
        <title>Coppelia Simulator - IDRA laboratory - Open Knowledge documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">IDRA laboratory - Open Knowledge  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">IDRA laboratory - Open Knowledge  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../01_ros_2/00_index.html">ROS2 Notes</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of ROS2 Notes</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../01_ros_2/01_CLI/00_index.html">CLI Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../01_ros_2/02_Packages/00_index.html">Workspaces and Packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../01_ros_2/10_Simulation/00_index.html">Simulation Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../01_ros_2/30_gazebo/00_index.html">Gazebo Simulator</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../00_index.html">Linux and other Utilities</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Linux and other Utilities</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../02_docker/00_index.html">Docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_github_actions/00_index.html">Github Actions for CI/CD</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Coppelia Simulator</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="coppelia-simulator">
<span id="coppeliasim"></span><h1>Coppelia Simulator<a class="headerlink" href="#coppelia-simulator" title="Link to this heading">#</a></h1>
<p><a class="reference external" href="https://www.coppeliarobotics.com/">Coppelia</a> is a simulator that can be easily integrated
in ROS2.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Installation and integration with ROS2 sections are based on notes provided by
<a class="reference external" href="https://github.com/Hydran00">Davide Nardi</a> and <a class="reference external" href="https://github.com/lucabeber">Luca Beber</a>.</p>
</div>
<section id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Link to this heading">#</a></h2>
<p>Go to the <a class="reference external" href="https://www.coppeliarobotics.com/downloads">download</a> page of the Coppelia
website and download the <em>CoppeliaSim Edu</em> version for Ubuntu 22.04.</p>
<p>The software is provided as a tarball; in the following example, the software is installed
in the <code class="docutils literal notranslate"><span class="pre">~/CoppeliaSim</span></code> directory:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tar<span class="w"> </span>-xf<span class="w"> </span>~/Downloads/CoppeliaSim_Edu*
mv<span class="w"> </span>CoppeliaSim_Edu*<span class="w"> </span>~/CoppeliaSim
<span class="c1"># Optionally delete the tarball</span>
rm<span class="w"> </span>~/Downloads/CoppeliaSim_Edu*.tar.xz
</pre></div>
</div>
<p>It is recommended to store the root directory of the CoppeliaSim installation as a
environment variable, so that it can be easily accessed from the terminal and the rest
of the presented code snippet can work with no problem. To do so add in the <code class="docutils literal notranslate"><span class="pre">~/.bashrc</span></code>
file the line</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">COPPELIASIM_ROOT_DIR</span><span class="o">=</span><span class="nv">$HOME</span>/CoppeliaSim
</pre></div>
</div>
<p>or, more simply, call the command</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;export COPPELIASIM_ROOT_DIR=</span><span class="nv">$HOME</span><span class="s2">/CoppeliaSim&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.bashrc
</pre></div>
</div>
</section>
<section id="ros2-setup">
<h2>ROS2 Setup<a class="headerlink" href="#ros2-setup" title="Link to this heading">#</a></h2>
<section id="messages">
<h3>Messages<a class="headerlink" href="#messages" title="Link to this heading">#</a></h3>
<p>CoppeliaSim has a ros2 workspace internally which is used to build required ROS2 messages.
Messages that needs to be build must be specified inside the folder</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$COPPELIASIM_ROOT_FOLDER</span>/programming/ros2_packages/sim_ros2_interface/meta
</pre></div>
</div>
<p>In particular inside the file <code class="docutils literal notranslate"><span class="pre">interfaces.txt</span></code> must be listed all the required messages,
for instance</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>geometry_msgs/msg/Wrench
geometry_msgs/msg/WrenchStamped
std_msgs/msg/MultiArrayDimension
std_msgs/msg/MultiArrayLayout
std_msgs/msg/Float64MultiArray
sensor_msgs/msg/JointState
rosgraph_msgs/msg/Clock
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To automatically append messages to the file <code class="docutils literal notranslate"><span class="pre">interfaces.txt</span></code>,
you might want to use the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span><span class="s">&lt;&lt; EOF &gt;&gt; $COPPE</span>LIASIM_ROOT_FOLDER/programming/ros2_packages/sim_ros2_interface/meta/interfaces.txt
</pre></div>
</div>
<p>In this way you can write the list of messages to be appended. Once all messages have been
listed, write <code class="docutils literal notranslate"><span class="pre">EOF</span></code> on a new line and press enter to apply changes.</p>
<p>As example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span><span class="s">&lt;&lt; EOF &gt;&gt; $COPPELIASIM_ROOT_FOLDER/programming/ros2_packages/sim_ros2_interface/meta/interfaces.txt</span>
<span class="s">geometry_msgs/msg/Wrench</span>
<span class="s">geometry_msgs/msg/WrenchStamped</span>
<span class="s">std_msgs/msg/MultiArrayDimension</span>
<span class="s">std_msgs/msg/MultiArrayLayout</span>
<span class="s">std_msgs/msg/Float64MultiArray</span>
<span class="s">sensor_msgs/msg/JointState</span>
<span class="s">rosgraph_msgs/msg/Clock</span>
<span class="s">EOF</span>
</pre></div>
</div>
</div>
</section>
<section id="workspace-build">
<h3>Workspace build<a class="headerlink" href="#workspace-build" title="Link to this heading">#</a></h3>
<p>After required messages have been configured, the ROS2 workspace must be built. This can
be accomplished with the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span><span class="nv">$COPPELIASIM_ROOT_FOLDER</span>/programming/ros2_packages/sim_ros2_interface
colcon<span class="w"> </span>build<span class="w"> </span>--symlink-install
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In case of compilation errors, try the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">VERBOSE</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">MAKEFLAGS</span><span class="o">=</span>-j1<span class="w"> </span>colcon<span class="w"> </span>build<span class="w"> </span>--symlink-install<span class="w"> </span>--event-handlers<span class="w"> </span>console_direct+<span class="w"> </span>--parallel-workers<span class="w"> </span><span class="m">1</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="ros2-simulation-interface">
<h2>ROS2 simulation interface<a class="headerlink" href="#ros2-simulation-interface" title="Link to this heading">#</a></h2>
<p>Coppelia does not provide a <em>standard</em> interface with the ROS simulator, but nodes must
be programmed in the Coppelia environment to exchange data.</p>
<p>For this purpose, the preferred scripting language is <a class="reference external" href="https://www.lua.org/">LUA</a>, which
is faster than Python (that’s another alternative in Coppelia).</p>
<p>Scritps are bounded to objects in Coppelia: for this reason it is recommended to write code
that belongs to the object itself, and not to the scene, so that if the entity is copied
and pasted in other projects, the programmed interface is preserved.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To see the list of all available API function, look
<a class="reference external" href="https://www.coppeliarobotics.com/helpFiles/en/apiFunctions.htm">here</a>.</p>
</div>
<section id="robot-simulation">
<span id="coppeliasim-ros2-robot-script"></span><h3>Robot simulation<a class="headerlink" href="#robot-simulation" title="Link to this heading">#</a></h3>
<p>This is an example scritp for a kinematic simulation of a robot in Coppelia that provide
a good understanding of the interface principle. Here the code will be splitted up and
explained in details; the whole script can be found <a class="reference internal" href="02_ros2_integration/02b_robot_interface_example.html#ros2-robot-integration"><span class="std std-ref">here</span></a>.</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nc">table</span><span class="p">.</span><span class="nf">fill</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="kr">do</span>
        <span class="nb">table.insert</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="kr">end</span>
    <span class="kr">return</span> <span class="n">t</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>This is a simple used-defined function that allows to initialize a table with <code class="docutils literal notranslate"><span class="pre">n</span></code> equal
elements <code class="docutils literal notranslate"><span class="pre">value</span></code>; this is useful, as example, for the initialization of the joint handles or maximum
joint properties</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">q_home</span> <span class="o">=</span> <span class="p">{</span><span class="mf">1.57</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.57</span><span class="p">,</span> <span class="mf">1.57</span> <span class="p">,</span> <span class="o">-</span><span class="mf">1.57</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.57</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">}</span>
<span class="n">joints</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">q_home</span>
<span class="kd">local</span> <span class="n">max_vel</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">180</span> <span class="o">*</span> <span class="nb">math.pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">max_acc</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">40</span> <span class="o">*</span> <span class="nb">math.pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">max_jerk</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">80</span> <span class="o">*</span> <span class="nb">math.pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
<p>Here it is reported the initialization of main variables; <code class="docutils literal notranslate"><span class="pre">q_home</span></code> is the home configuration
of the robot (in the joint space), while <code class="docutils literal notranslate"><span class="pre">joints</span></code> is is a placeholder that will contain
the Coppelia handles of the joints of the robot (i.e. the joint object inside the Coppelia
object tree).
For sake of simplicity, the initial target is set to the home configuration, while joint
limits (for both velocity, acceleration and jerk) are initialized to values that are
constant for all joints.</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">apply_joint_position</span><span class="p">(</span><span class="n">ros_msg</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">ros_msg</span><span class="p">.</span><span class="n">data</span>
    <span class="kr">if</span><span class="p">(</span><span class="nb">tostring</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="s2">&quot;nan&quot;</span><span class="p">)</span> <span class="kr">then</span>
        <span class="kr">return</span>
    <span class="kr">end</span>
    <span class="n">msg_received</span> <span class="o">=</span> <span class="kc">true</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>This function is the callback from the ROS2 subscriber (that will be initialized later);
it takes the desired joint configuration for the system and sets the <code class="docutils literal notranslate"><span class="pre">target</span></code> accordingly.
The <code class="docutils literal notranslate"><span class="pre">msg_received</span></code> boolean flag is used to assert when a new correct message is arrived.
After processing of during the actuation step of the simulation, the flag will be set to <code class="docutils literal notranslate"><span class="pre">false</span></code> again.</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">move_to_config</span><span class="p">(</span><span class="n">handles</span><span class="p">,</span> <span class="n">max_vel</span><span class="p">,</span> <span class="n">max_acc</span><span class="p">,</span> <span class="n">max_jerk</span><span class="p">,</span> <span class="n">target_pos</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">current_pos</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="kd">local</span> <span class="n">current_vel</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="kr">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="o">#</span><span class="n">handles</span><span class="p">,</span><span class="mi">1</span> <span class="kr">do</span>
        <span class="n">current_pos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="p">.</span><span class="n">getJointPosition</span><span class="p">(</span><span class="n">handles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">current_vel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="p">.</span><span class="n">getJointVelocity</span><span class="p">(</span><span class="n">handles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="kr">end</span>

    <span class="n">sim</span><span class="p">.</span><span class="n">moveToConfig</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">current_pos</span><span class="p">,</span> <span class="n">current_vel</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">max_vel</span><span class="p">,</span> <span class="n">max_acc</span><span class="p">,</span> <span class="n">max_jerk</span><span class="p">,</span>
                     <span class="n">target_pos</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">mov_callback</span><span class="p">,</span> <span class="n">handles</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">mov_callback</span><span class="p">(</span><span class="n">target_pos</span><span class="p">,</span><span class="n">vel</span><span class="p">,</span><span class="n">acc</span><span class="p">,</span><span class="n">handles</span><span class="p">)</span>
    <span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">#</span><span class="n">handles</span><span class="p">,</span> <span class="mi">1</span> <span class="kr">do</span>
            <span class="n">sim</span><span class="p">.</span><span class="n">setJointTargetPosition</span><span class="p">(</span><span class="n">handles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">target_pos</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="kr">end</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>This function implements the interface with coppelia that sets the target joint configuration
for the kinematic simulation of the robot. The <code class="docutils literal notranslate"><span class="pre">handles</span></code> are the joints that are commanded
with the specified joint limits. Internally the function collects the current state of
the robot (i.e. joint position and velocity) and calls the built-in <code class="docutils literal notranslate"><span class="pre">sim.moveToConfig</span></code>
<a class="reference external" href="https://www.coppeliarobotics.com/helpFiles/en/regularApi/simMoveToConfig.htm">documented here</a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">mov_callback</span></code> function is the callback that processes the result of the <code class="docutils literal notranslate"><span class="pre">sim.moveToConfig</span></code>.</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">sysCall_init</span><span class="p">()</span>
    <span class="kr">if</span> <span class="n">simROS2</span> <span class="kr">then</span>
        <span class="n">publisher</span> <span class="o">=</span> <span class="n">simROS2</span><span class="p">.</span><span class="n">createPublisher</span><span class="p">(</span>
            <span class="s1">&#39;/coppelia_joint_states&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sensor_msgs/msg/JointState&#39;</span>
            <span class="p">)</span>
        <span class="n">subscriber</span> <span class="o">=</span> <span class="n">simROS2</span><span class="p">.</span><span class="n">createSubscription</span><span class="p">(</span>
            <span class="s1">&#39;/coppelia_set_joints&#39;</span><span class="p">,</span>
            <span class="s1">&#39;std_msgs/msg/Float64MultiArray&#39;</span><span class="p">,</span>
            <span class="s1">&#39;apply_joint_position&#39;</span>
            <span class="p">)</span>
    <span class="kr">end</span>

    <span class="n">joints</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="p">.</span><span class="n">getObject</span><span class="p">(</span><span class="s1">&#39;/shoulder_pan_joint&#39;</span><span class="p">)</span>
    <span class="n">joints</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="p">.</span><span class="n">getObject</span><span class="p">(</span><span class="s1">&#39;/shoulder_lift_joint&#39;</span><span class="p">)</span>
    <span class="n">joints</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="p">.</span><span class="n">getObject</span><span class="p">(</span><span class="s1">&#39;/elbow_joint&#39;</span><span class="p">)</span>
    <span class="n">joints</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="p">.</span><span class="n">getObject</span><span class="p">(</span><span class="s1">&#39;/wrist_1_joint&#39;</span><span class="p">)</span>
    <span class="n">joints</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="p">.</span><span class="n">getObject</span><span class="p">(</span><span class="s1">&#39;/wrist_2_joint&#39;</span><span class="p">)</span>
    <span class="n">joints</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="p">.</span><span class="n">getObject</span><span class="p">(</span><span class="s1">&#39;/wrist_3_joint&#39;</span><span class="p">)</span>

    <span class="n">move_to_config</span><span class="p">(</span><span class="n">joints</span><span class="p">,</span> <span class="n">max_vel</span><span class="p">,</span> <span class="n">max_acc</span><span class="p">,</span> <span class="n">max_jerk</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
    <span class="n">msg_received</span> <span class="o">=</span> <span class="kc">true</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">sysCall_init</span></code> function is the initialization function that is called automatically
by Coppelia at the beginning of the simulation, thus is used to initialize different elements.</p>
<p>In this case a ROS2 topic subscriber and publisher are initialized; the former reads
the desired joint configuration (that’s actually computer by a ROS controller) while the
latter publishes the current joint configuration of the robot.</p>
<p>Then, the <code class="docutils literal notranslate"><span class="pre">joints</span></code> handler are initialized by binding the associated Coppelia objects.
Furthermore, the robot is initially commanded to reach the home configuration.</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">sysCall_actuation</span><span class="p">()</span>
    <span class="kr">if</span> <span class="n">msg_received</span> <span class="o">==</span> <span class="kc">true</span> <span class="kr">then</span>
        <span class="n">move_to_config</span><span class="p">(</span><span class="n">joints</span><span class="p">,</span> <span class="n">max_vel</span><span class="p">,</span> <span class="n">max_acc</span><span class="p">,</span> <span class="n">max_jerk</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">msg_received</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="kr">end</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">sysCall_actuation</span></code> is the function that is called at each actuation step of the
simulation. In this case it checks if a new target position has been received from the
publisher and, if so, it calls the <code class="docutils literal notranslate"><span class="pre">move_to_config</span></code> function to update the simulation
target state.</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">sysCall_sensing</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">curr_pos</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="kd">local</span> <span class="n">curr_vel</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="kd">local</span> <span class="n">curr_torque</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="kr">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">#</span><span class="n">joints</span><span class="p">,</span> <span class="mi">1</span> <span class="kr">do</span>
        <span class="n">curr_pos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="p">.</span><span class="n">getJointPosition</span><span class="p">(</span><span class="n">joints</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">curr_vel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="p">.</span><span class="n">getJointVelocity</span><span class="p">(</span><span class="n">joints</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">curr_torque</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="p">.</span><span class="n">getJointForce</span><span class="p">(</span><span class="n">joints</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="kr">end</span>

    <span class="kd">local</span> <span class="n">msg</span> <span class="o">=</span><span class="p">{</span>
        <span class="n">header</span><span class="o">=</span><span class="p">{</span>
            <span class="n">stamp</span> <span class="o">=</span> <span class="n">simROS2</span><span class="p">.</span><span class="n">getSystemTime</span><span class="p">(),</span>
            <span class="n">frame_id</span> <span class="o">=</span> <span class="s1">&#39;robot_base&#39;</span>
        <span class="p">},</span>
        <span class="n">name</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;shoulder_pan_joint&#39;</span><span class="p">,</span> <span class="s1">&#39;shoulder_lif_joint&#39;</span><span class="p">,</span> <span class="s1">&#39;elbow_joint&#39;</span><span class="p">,</span>
            <span class="s1">&#39;wrist_1_joint&#39;</span><span class="p">,</span> <span class="s1">&#39;wrist_2_joint&#39;</span><span class="p">,</span> <span class="s1">&#39;wrist_3_joint&#39;</span>
        <span class="p">},</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">curr_pos</span><span class="p">,</span>
        <span class="n">velocity</span> <span class="o">=</span> <span class="n">curr_vel</span><span class="p">,</span>
        <span class="n">effort</span> <span class="o">=</span> <span class="n">curr_torque</span>
    <span class="p">}</span>
    <span class="n">simROS2</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">publisher</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>Finally, the <code class="docutils literal notranslate"><span class="pre">sysCall_sensing</span></code> function is called at each sensing step of the simulation;
in this case it reads the current joint configuration and publishes it to the ROS2 topic
as defined in the initialization.</p>
</section>
</section>
<section id="zeromq-remote-api">
<h2>ZeroMQ remote API<a class="headerlink" href="#zeromq-remote-api" title="Link to this heading">#</a></h2>
<p>As described <a class="reference external" href="https://www.coppeliarobotics.com/helpFiles/en/zmqRemoteApiOverview.htm">here</a>
Coppelia provides a remote API based on ZeroMQ.
This can be used to control the flow of the simulation, and in particular it can call
all <a class="reference external" href="https://www.coppeliarobotics.com/helpFiles/en/apiFunctions.htm">regular API</a> functions
that are available within the Coppelia environment.</p>
<section id="id2">
<h3>Installation<a class="headerlink" href="#id2" title="Link to this heading">#</a></h3>
<p>Coppelia provides a python package for accessing the ZeroMQ remote API that can be installed
as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>coppeliasim-zmqremoteapi-client
</pre></div>
</div>
</section>
<section id="usage">
<h3>Usage<a class="headerlink" href="#usage" title="Link to this heading">#</a></h3>
<p>The following is a simple python examples that ensures that a scene is loaded, it automatically
starts the simulation and it waits until the simulation time reaches 10 seconds before stopping
it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">coppeliasim_zmqremoteapi_client</span> <span class="kn">import</span> <span class="n">RemoteAPIClient</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">RemoteAPIClient</span><span class="p">()</span>
<span class="n">sim</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="s2">&quot;sim&quot;</span><span class="p">)</span>

<span class="n">sim</span><span class="o">.</span><span class="n">loadScene</span><span class="p">(</span><span class="s2">&quot;/path/to/scene.ttt&quot;</span><span class="p">)</span>
<span class="n">sim</span><span class="o">.</span><span class="n">startSimulation</span><span class="p">()</span>

<span class="k">while</span> <span class="n">sim</span><span class="o">.</span><span class="n">getSimulationTime</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="n">sim</span><span class="o">.</span><span class="n">stopSimulation</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="tips-and-tricks">
<h2>Tips and Tricks<a class="headerlink" href="#tips-and-tricks" title="Link to this heading">#</a></h2>
<section id="automatic-simulation-start">
<h3>Automatic simulation start<a class="headerlink" href="#automatic-simulation-start" title="Link to this heading">#</a></h3>
<p>One can automatically boot up the Coppeliasim simulator on a given scene calling</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$COPPELIASIM_ROOT_DIR</span>/coppeliaSim.sh<span class="w"> </span>/path/to/scene.ttt
</pre></div>
</div>
<p>This operation can be performed also inside python, for instance when we want to start
the simulator a launch file.
We can check if the simulator is already running by checking the active processes on the
system using the <code class="docutils literal notranslate"><span class="pre">psutil</span></code> library (that can be installed with <code class="docutils literal notranslate"><span class="pre">pip3</span> <span class="pre">install</span> <span class="pre">psutil</span></code>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">psutil</span>

<span class="n">is_running</span> <span class="o">=</span> <span class="s2">&quot;coppeliaSim&quot;</span> <span class="ow">in</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">psutil</span><span class="o">.</span><span class="n">process_iter</span><span class="p">())</span>
</pre></div>
</div>
<p>Using the <code class="docutils literal notranslate"><span class="pre">subprocess</span></code> python package one can also execute the command that boots the
simulator with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="n">coppeliasim_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;COPPELIASIM_ROOT_DIR&quot;</span><span class="p">]</span>
<span class="n">scene</span> <span class="o">=</span> <span class="s2">&quot;/path/to/scene.ttt&quot;</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">coppeliasim_dir</span><span class="si">}</span><span class="s2">/coppeliaSim.sh&quot;</span><span class="p">,</span> <span class="n">scene</span><span class="p">])</span>
</pre></div>
</div>
<p>Combining the 2 scripts one could do</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="k">if</span> <span class="s2">&quot;coppeliaSim&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">psutil</span><span class="o">.</span><span class="n">process_iter</span><span class="p">()):</span>
    <span class="n">coppeliasim_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;COPPELIASIM_ROOT_DIR&quot;</span><span class="p">]</span>
    <span class="n">scene</span> <span class="o">=</span> <span class="s2">&quot;/path/to/scene.ttt&quot;</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">coppeliasim_dir</span><span class="si">}</span><span class="s2">/coppeliaSim.sh&quot;</span><span class="p">,</span> <span class="n">scene</span><span class="p">],</span>
                     <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
                     <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          <a class="prev-page" href="../03_github_actions/00_index.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Github Actions for CI/CD</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; The IDRA team - 2023
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Coppelia Simulator</a><ul>
<li><a class="reference internal" href="#installation">Installation</a></li>
<li><a class="reference internal" href="#ros2-setup">ROS2 Setup</a><ul>
<li><a class="reference internal" href="#messages">Messages</a></li>
<li><a class="reference internal" href="#workspace-build">Workspace build</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ros2-simulation-interface">ROS2 simulation interface</a><ul>
<li><a class="reference internal" href="#robot-simulation">Robot simulation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#zeromq-remote-api">ZeroMQ remote API</a><ul>
<li><a class="reference internal" href="#id2">Installation</a></li>
<li><a class="reference internal" href="#usage">Usage</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tips-and-tricks">Tips and Tricks</a><ul>
<li><a class="reference internal" href="#automatic-simulation-start">Automatic simulation start</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=32e29ea5"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    </body>
</html>